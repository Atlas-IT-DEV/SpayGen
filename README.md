# SpayGen: AI-powered Full-Page HTML Modifier (Langgraph & Langchain Version)

## Обзор
SpayGen - это демонстрационное решение для модификации и уникализации существующих полностраничных HTML-шаблонов с использованием агентов на базе **Langgraph** и **Langchain**. Проект разработан с акцентом на модульность, расширяемость и соответствие принципам объектно-ориентированного программирования (ООП).

Новая архитектура фокусируется на:
- Выборе наиболее подходящего полностраничного HTML-шаблона из библиотеки.
- Генерации уникального контента, адаптированного под выбранный шаблон.
- Интеллектуальной модификации HTML и CSS шаблона для вставки нового контента, изменения стилей и уникализации кода.
- Комплексной валидации и уникализации финальной страницы.

## Особенности
- **Автоматическая загрузка и поиск шаблонов:** Полностраничные HTML-шаблоны автоматически загружаются из папки `templates/full_page_html` в векторную базу данных Qdrant при запуске приложения. Подбор шаблонов осуществляется на основе семантической близости с использованием эмбеддингов OpenAI, учитывая детальное текстовое описание желаемого вида страницы (`page_description`).
- **Оркестрация агентов с Langgraph:** Процесс генерации страницы координируется сложным графом состояний (StateGraph) в Langgraph, где каждый шаг представлен отдельным узлом (node). Это обеспечивает гибкость, наблюдаемость и управляемость потоком выполнения:
  1. **Template Selection Node:** Выбирает наиболее подходящий полностраничный HTML-шаблон из Qdrant на основе `WhitePageSpec` и `page_description`.
  2. **Content Generation Node:** Генерирует структурированный контент (текст, изображения, данные продуктов) для модификации выбранного шаблона с использованием LLM.
  3. **Modification Decision Node:** Определяет, следует ли использовать стандартную модификацию или модификацию по частям (chunked modification) для больших шаблонов.
  4. **Standard Modification Node:** Модифицирует HTML/CSS шаблона, заменяя плейсхолдеры, изменяя стили и вставляя новый контент.
  5. **Chunked Modification Node:** Для больших шаблонов, разбивает HTML на части, обрабатывает каждую часть отдельно с помощью LLM, а затем собирает их обратно, применяя дополнительные исправления структуры.
  6. **Validation Node:** Проверяет модифицированный HTML на валидность, семантику, доступность и соответствие `WhitePageSpec`, а также принимает решение о необходимости целевых исправлений или полной регенерации.
  7. **Targeted Fixing Node:** Применяет точечные исправления к HTML на основе ошибок валидации, используя как LLM, так и правила.
  8. **Uniqueness Node:** Уникализирует финальный HTML и CSS код страницы, изменяя стили, форматирование и структуру, сохраняя при этом функциональность и внешний вид.
  9. **HTML Rewriting Node:** Выполняет финальное переформатирование и очистку HTML для улучшения читаемости и структуры.
  10. **Check Final Result Node:** Оценивает финальный результат и принимает решение о завершении процесса или повторной попытке всей цепочки.
- **Гибкая конфигурация:** Все ключевые параметры приложения настраиваются через переменные окружения.
- **Улучшенное логирование:** Детальное логирование для отслеживания хода выполнения и отладки.
- **Внедрение зависимостей:** Использование принципов внедрения зависимостей для повышения тестируемости и гибкости компонентов.

## Структура проекта
```
SpayGen/
├── README.md               # Этот файл
├── pyproject.toml          # Метаданные проекта и зависимости
├── uv.lock                 # Зафиксированные версии зависимостей (управляется uv)
├── templates/              # Папка для хранения HTML-шаблонов
│   └── full_page_html/     # Полностраничные HTML-шаблоны
│       ├── ecommerce_basic/
│       │   ├── template.html
│       │   ├── style.css
│       │   └── description.txt
│       └── landing_page_contact/
│           ├── template.html
│           ├── style.css
│           └── description.txt
├── src/
│   ├── langgraph_agents/      # Реализация агентов и оркестратора на Langgraph
│   │   ├── __init__.py
│   │   ├── state.py           # Определение состояния графа Langgraph (GraphState)
│   │   ├── orchestrator_graph.py # Основной граф Langgraph, координирующий процесс
│   │   ├── template_node.py   # Узел для выбора шаблона
│   │   ├── content_node.py    # Узел для генерации контента
│   │   ├── modifier_node.py   # Узел для стандартной модификации HTML/CSS
│   │   ├── chunked_modification_node.py # Узел для модификации HTML по частям
│   │   ├── chunk_processor_node.py # Вспомогательный класс для обработки отдельных HTML-частей
│   │   ├── selective_chunk_processor_node.py # Вспомогательный класс для селективной обработки и повторных попыток частей
│   │   ├── validation_node.py # Узел для валидации HTML и принятия решений о фиксации/регенерации
│   │   ├── targeted_fixing_node.py # Узел для применения точечных исправлений HTML
│   │   ├── uniqueness_node.py # Узел для уникализации HTML/CSS
│   │   └── html_rewriting_node.py # Узел для финального переформатирования HTML
│   ├── config/                # Настройки приложения
│   │   └── settings.py        # Загрузка настроек из переменных окружения
│   ├── core/                  # Основные компоненты
│   │   ├── html_chunker.py    # Утилита для разбиения HTML на части
│   │   └── utils.py           # (Если есть) другие вспомогательные утилиты
│   ├── models/                # Pydantic модели данных
│   │   ├── pydantic_models.py
│   ├── server.py              # FastAPI сервер для API (обновлен для использования Langgraph)
│   └── tools/                 # Вспомогательные инструменты
│       ├── bing_validator.py
│       ├── qdrant_manager.py
│       └── template_loader.py
└── generation/             # Папка для сохранения сгенерированных страниц
```